name: Update Profile README with Repo Traffic

on:
  schedule:
    - cron: "0 0 * * *"  # Runs once per day
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout SpringBoot Repo
        uses: actions/checkout@v3
        with:
          repository: hendzormati/SpringBoot

      - name: Fetch Traffic Stats
        run: |
          OWNER="hendzormati"
          REPO="SpringBoot"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          # Fetch repo views
          VIEWS=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/traffic/views" | jq '.count')

          # Fetch repo clones
          CLONES=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/traffic/clones" | jq '.count')

          # Get current date
          DATE=$(date +"%Y-%m-%d")

          # Save data to a file
          echo "👁️ **Total Views (last 14 days):** $VIEWS" > traffic.txt
          echo "🔄 **Total Clones (last 14 days):** $CLONES" >> traffic.txt
          echo "_Last updated: **$DATE**_" >> traffic.txt

      - name: Checkout Profile README Repo
        uses: actions/checkout@v3
        with:
          repository: hendzormati/hendzormati
          token: ${{ secrets.PAT_SECRET }}

      - name: Update README
        run: |
          # Replace old traffic data in README.md
          sed -i '/### 📊 Repository Stats/,/Last updated:/{
            r traffic.txt
            d
          }' README.md

      - name: Commit & Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "Auto-update repository traffic"
          git push
