name: Update Repo Traffic in README

on:
  schedule:
    - cron: '0 0 * * *'  # Every 24 hours at midnight (UTC)
  workflow_dispatch:  # Allows you to trigger the workflow manually from GitHub UI

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Get traffic data for SpringBoot repo
      id: traffic
      run: |
        # Fetch traffic data for the SpringBoot repository
        VIEWS=$(curl -s -H "Authorization: token ${{ secrets.PAT_SECRET }}" https://api.github.com/repos/hendzormati/SpringBoot/traffic/views)
        CLONES=$(curl -s -H "Authorization: token ${{ secrets.PAT_SECRET }}" https://api.github.com/repos/hendzormati/SpringBoot/traffic/clones)
        
        # Parse the counts from the API responses
        VIEWS_COUNT=$(echo $VIEWS | jq '.count')
        CLONES_COUNT=$(echo $CLONES | jq '.count')
        
        # Output the counts for debugging purposes
        echo "Views: $VIEWS_COUNT"
        echo "Clones: $CLONES_COUNT"
        
        # Set the counts as environment variables for later use
        echo "views_count=$VIEWS_COUNT" >> $GITHUB_ENV
        echo "clones_count=$CLONES_COUNT" >> $GITHUB_ENV

    - name: Update README with traffic data
      run: |
        # Read the existing README file
        README_CONTENT=$(cat README.md)
        
        # Replace placeholders with actual data
        UPDATED_README=$(echo "$README_CONTENT" | sed "s/ðŸ‘ï¸ Total Views (last 14 days):.*/ðŸ‘ï¸ Total Views (last 14 days): ${{ env.views_count }}/")
        UPDATED_README=$(echo "$UPDATED_README" | sed "s/ðŸ”„ Total Clones (last 14 days):.*/ðŸ”„ Total Clones (last 14 days): ${{ env.clones_count }}/")
        UPDATED_README=$(echo "$UPDATED_README" | sed "s/Last updated:.*/Last updated: $(date)/")
        
        # Write the updated README back to the file
        echo "$UPDATED_README" > README.md

    - name: Commit and push changes
      uses: EndBug/add-and-commit@v7
      with:
        author_name: "GitHub Actions"
        author_email: "actions@github.com"
        message: "Update README with latest repo traffic data"
