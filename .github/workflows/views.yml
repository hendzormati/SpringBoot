name: Update Profile README with Repo Traffic

on:
  schedule:
    - cron: "0 0 * * *"  # Run once every day at midnight
  workflow_dispatch: # Trigger manually if needed

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Get repository traffic stats
      - name: Get repo traffic data
        id: traffic
        run: |
          VIEWS=$(curl -H "Authorization: token ${{ secrets.PAT_SECRET }}" https://api.github.com/repos/hendzormati/SpringBoot/traffic/views)
          CLONES=$(curl -H "Authorization: token ${{ secrets.PAT_SECRET }}" https://api.github.com/repos/hendzormati/SpringBoot/traffic/clones)
          echo "::set-output name=views::$VIEWS"
          echo "::set-output name=clones::$CLONES"

      # Step 3: Extract count from the traffic data
      - name: Extract traffic counts
        id: traffic_counts
        run: |
          VIEWS_COUNT=$(echo ${{ steps.traffic.outputs.views }} | jq '.count')
          CLONES_COUNT=$(echo ${{ steps.traffic.outputs.clones }} | jq '.count')
          echo "Views: $VIEWS_COUNT"
          echo "Clones: $CLONES_COUNT"
          echo "::set-output name=views_count::$VIEWS_COUNT"
          echo "::set-output name=clones_count::$CLONES_COUNT"

      # Step 4: Update the README file
      - name: Update README.md with traffic data
        run: |
          echo "ðŸ‘ï¸ **Total Views (last 14 days):** ${{ steps.traffic_counts.outputs.views_count }}" > traffic.txt
          echo "ðŸ”„ **Total Clones (last 14 days):** ${{ steps.traffic_counts.outputs.clones_count }}" >> traffic.txt
          echo "_Last updated: $(date +'%Y-%m-%d')_" >> traffic.txt
          sed -i '/### ðŸ“Š Repository Stats/,/Last updated:/{
            r traffic.txt
            d
          }' README.md

      # Step 5: Commit the updated README
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Update profile README with repo traffic"
          git push
